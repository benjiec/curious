'use strict';function SearchController($scope,$routeParams,$http,$timeout,$location,RecentQueries){$scope.__base_url='/curious';$scope.query='';$scope.query_error='';$scope.query_accepted='';$scope.delayPromise=undefined;$scope.recent_queries=RecentQueries;$scope.query_submitted=[];if($routeParams&&$routeParams.query){$scope.query=$routeParams.query;$scope.query_submitted=[$scope.query];var i=$scope.recent_queries.indexOf($routeParams.query);if(i<0){$scope.recent_queries.unshift($routeParams.query);}}
$scope.delayCheckQuery=function(){if($scope.delayPromise!==undefined){$timeout.cancel($scope.delayPromise);$scope.delayPromise=undefined;}
$scope.delayPromise=$timeout(function(){$scope.checkQuery();$scope.delayPromise=undefined;},1000);};$scope._check_query=function(query_string,cb){var url=$scope.__base_url+'/q/';var url=url+'?c=1&q='+encodeURIComponent(query_string);$http.get(url).success(function(data){cb(data.result.query,'');}).error(function(data,status,headers,config){var err='';if(data.error){err=data.error.message;}
else{err='Unspecified error';}
cb('',err);});};$scope._new_query=function(query){var url='/q/'+encodeURI(query);$location.path(url);}
$scope.checkQuery=function(cb){$scope._check_query($scope.query,function(query_string,err){$scope.query_error=err;$scope.query_accepted=query_string;if(cb!==undefined){cb(query_string,err);}});};$scope.submitQuery=function(){$scope.checkQuery(function(query_string,err){if(query_string!==''){$scope._new_query(query_string);}});};$scope.extendQuery=function(model,rel){$scope.query=$scope.query+' '+model+'.'+rel;$scope.submitQuery();};}
var app=angular.module('curious',['ngRoute','ngSanitize']).config(['$routeProvider',function($routeProvider){$routeProvider.when('/',{template:JST['search'],controller:SearchController}).when('/q/:query*',{template:JST['search'],controller:SearchController}).otherwise({redirectTo:'/'});}]);app.directive('partial',function($compile){var linker=function(scope,element,attrs){element.html(JST[attrs.template]());$compile(element.contents())(scope);};return{link:linker,restrict:'E'}});app.filter('encodeURIComponent',function(){return window.encodeURIComponent;});app.filter('encodeURI',function(){return window.encodeURI;});app.filter('showAttr',function(){return function(obj){if(obj&&obj.hasOwnProperty('display')){return obj.display;}
else{return obj;}}});app.factory('RecentQueries',function(){return[];});

function curiousJoinTable(results,set_table_cb,get_objects_f){


 var GET_BATCH=500; var DEFAULT_PAGE_SIZE=100;var entries=[];var objects=[];var models=[]; var tbl_queries=[];var tbl_attrs=[];var tbl_rows=[];var tbl_view=undefined;var tbl_csv=undefined;
 for(var i=0;i<results.length;i++){results[i].map={}
for(var j=0;j<results[i].objects.length;j++){var obj=results[i].objects[j];if(results[i].map[obj[0]]===undefined){results[i].map[obj[0]]=[];}
results[i].map[obj[0]].push(obj);}}
function build_obj(col,res_obj){return{model:results[col].model,id:res_obj[0],url:res_obj[1],from:res_obj[2]};}
var entries=[];var last_column=results[results.length-1];for(var i=0;i<last_column.objects.length;i++){entries.push([build_obj(results.length-1,last_column.objects[i])]);}
for(var col=results.length-2;col>=0;col--){var new_entries=[];for(var i=0;i<entries.length;i++){var row=entries[i];var last_from=row[0].from; var objs=results[col].map[last_from];for(var j=0;j<objs.length;j++){var new_row=row.slice(0);new_row.unshift(build_obj(col,objs[j]));new_entries.push(new_row);}}
entries=new_entries;} 
entries.sort(function(a,b){return a[0].id-b[0].id;});

for(var i=0;i<entries.length;i++){for(var j=0;j<entries[i].length;j++){var entry=entries[i][j];var obj_id=entry.model+'.'+entry.id;if(objects[obj_id]===undefined){var id_str=''+entry.id;if(entry.url){id_str='<a href="'+entry.url+'">'+entry.id+'</a>';}
objects[obj_id]={id:{value:entry.id,display:id_str}};}
entry['ptr']=objects[obj_id];}} 
for(var j=0;j<entries[0].length;j++){tbl_queries.push({model:entries[0][j].model,cols:1});models.push({model:entries[0][j].model,attrs:[{name:'id',visible:true}],loaded:false});} 
function add_object_data(model,obj_data){var id=obj_data.id;var obj_id=model+'.'+id;var ptr=objects[obj_id];ptr['__fetched__']=obj_data;for(var a in obj_data){ if(a!=='id'){
var v=obj_data[a];var s=v;if(v&&v.model){if('__str__'in v){s=v['__str__'];if(v.id){s+=' ('+v.id+')';}}
if('url'in v){s='<a href="'+v.url+'">'+s+'</a>';}}
ptr[a]={value:v,display:s};}}}

function get_objects(model,ids,cb){var cb_data=undefined;var unfetched=[];for(var i=0;i<ids.length;i++){var id=ids[i];var obj_id=model+'.'+id;if(obj_id in objects&&objects[obj_id]['__fetched__']){cb_data=objects[obj_id]['__fetched__'];}
else{unfetched.push(id);}}
if(cb_data!==undefined&&cb){cb(cb_data);}
if(unfetched.length>0){while(unfetched.length>0){var tofetch=unfetched.slice(0,GET_BATCH);var unfetched=unfetched.slice(GET_BATCH);get_objects_f(model,tofetch,function(results){for(var i=0;i<results.length;i++){var obj_data=results[i];add_object_data(model,obj_data);if(cb_data===undefined&&cb){cb_data=obj_data;cb(obj_data);}}});}}}
function csv(){if(tbl_rows.length==0){return"";}
var csv_rows=[]
var row0=tbl_rows[0];var header=[];for(var i=0;i<tbl_attrs.length;i++){var model=row0[i].model;header.push(model+'.'+tbl_attrs[i].name);}
csv_rows.push(header.join(','));for(var i=0;i<tbl_rows.length;i++){var row=[];for(var j=0;j<tbl_rows[i].length;j++){var entry=tbl_rows[i][j];if(entry){var obj=entry.ptr;if(obj){var v=obj[tbl_attrs[j].name];if(v.display){v=v.value;}
if(v){v=''+v; v=v.replace("\n"," ");v=v.replace("\t"," ");v=v.replace("\"","");v=v.replace("\'","");v="\""+v+"\"";}
row.push(v);}
else{if(tbl_attrs[j].name=='id'){row.push(entry.id);}
else{row.push('');}}}
else{if(tbl_attrs[j].name=='id'){row.push(entry.id);}
else{row.push('');}}}
csv_rows.push(row.join(','));}
return csv_rows.join('\n');}
function update_pourover(page_size){var col_data=[];for(var i=0;i<tbl_rows.length;i++){col_data.push({i:i,row:tbl_rows[i]});}
var collection=new PourOver.Collection(col_data);if(page_size===undefined){page_size=DEFAULT_PAGE_SIZE;}
tbl_view=new PourOver.View('default',collection,{page_size:page_size});}
function next_page(){tbl_view.page(1);}
function prev_page(){tbl_view.page(-1);}
function update_csv(){if(tbl_csv){tbl_csv=csv();}}

function update_table(){tbl_attrs=[];var attr_model_idx=[];for(var i=0;i<models.length;i++){for(var j=0;j<models[i].attrs.length;j++){tbl_attrs.push(models[i].attrs[j]);attr_model_idx.push(i);}}
tbl_rows=[];for(var i=0;i<entries.length;i++){var row=[];for(var j=0;j<tbl_attrs.length;j++){var k=attr_model_idx[j];row.push(entries[i][k]);}
tbl_rows.push(row);}
update_pourover(); update_csv(); update_controller();}
function update_controller(){ set_table_cb({queries:tbl_queries,attrs:tbl_attrs,length:tbl_rows.length,view:tbl_view,csv:tbl_csv, toggleQuery:toggle,showCSV:show_csv,nextPage:next_page,prevPage:prev_page});}

function update_model_attrs(query_idx,object){if(models[query_idx].attrs.length==1){var old_attr=models[query_idx].attrs[0];var attrs=[];for(var a in object){if(a!=='id'){attrs.push({name:a,visible:true});}}
attrs.sort(function(a,b){return a.name-b.name;});attrs.unshift(old_attr);models[query_idx].attrs=attrs;tbl_queries[query_idx].cols=attrs.length;update_table();}} 
function show_object_attrs(query_idx){if(models[query_idx].loaded==true){ for(var i=0;i<models[query_idx].attrs.length;i++){models[query_idx].attrs[i].visible=true;}
tbl_queries[query_idx].cols=models[query_idx].attrs.length;return;} 
var ids=[];for(var i=0;i<entries.length;i++){var entry=entries[i][query_idx];ids.push(entry.ptr.id.value);}
get_objects(models[query_idx].model,ids,function(data){update_model_attrs(query_idx,data);models[query_idx].loaded=true;});} 
function hide_object_attrs(query_idx){ for(var i=0;i<models[query_idx].attrs.length;i++){if(models[query_idx].attrs[i].name!=='id'){models[query_idx].attrs[i].visible=false;}}
tbl_queries[query_idx].cols=1;}
function toggle(query_idx){if(tbl_queries[query_idx].cols==1){show_object_attrs(query_idx);}
else{hide_object_attrs(query_idx);}}
function show_csv(){tbl_csv=csv();update_controller();}
update_table();
 if(entries.length<200){show_object_attrs(entries[0].length-1);}}'use strict';function QueryController($scope,$http){function init_query(){$scope.completed=false;$scope.success=false;$scope.search_error=undefined;$scope.last_model=undefined;$scope.last_model_rels=[];$scope.table=undefined;$scope.csv=undefined;}
function get_model(model,cb){var url=$scope.__base_url+'/models/'+model+'/';$http.get(url).success(function(data){if(data.result){cb(data.result,undefined);}
else{cb(undefined,"Cannot retrieve model information from server");}}).error(function(data,status,headers,config){if(data.error){cb(undefined,data.error.message);}
else{cb(undefined,"Unspecified error from server");}});}
function get_object(model,id,cb){var url=$scope.__base_url+'/objects/'+model+'/'+id+'/';$http.get(url).success(function(data){if(data.result){cb(data.result);}});}
function get_objects(model,ids,cb){var url=$scope.__base_url+'/models/'+model+'/';$http.post(url,{ids:ids}).success(function(data){if(data.result){cb(data.result);}});}
function do_query(query_string,cb){var url=$scope.__base_url+'/q/';var url=url+'?q='+encodeURIComponent(query_string);$http.get(url).success(function(data){if(data.result){cb(data.result,undefined);}
else{cb(undefined,"Did not receive results from server");}}).error(function(data,status,headers,config){if(data.error){cb(undefined,data.error.message);}
else{cb(undefined,"Unspecified error from server");}});}
function execute(){init_query();var query=$scope.query;do_query(query,function(result,err){$scope.completed=true;if(err){$scope.success=false;$scope.search_error=err;}
else{$scope.success=true;if(result.length>0){$scope.last_model=result[result.length-1].model;get_model($scope.last_model,function(result,error){if(result){if(result.relationships){$scope.last_model_rels=result.relationships;}}}); curiousJoinTable(result,function(tbl){$scope.table=tbl;},get_objects);}}});}
$scope.showCSV=function(){$scope.csv=$scope.table.csv();}
execute();};