var app=angular.module('curious',['ngRoute','ngSanitize']).config(['$routeProvider',function($routeProvider){$routeProvider.when('/',{template:JST['search'],controller:SearchController}).when('/q/:query*',{template:JST['search'],controller:SearchController}).otherwise({redirectTo:'/'});}]);app.directive('partial',function($compile){var linker=function(scope,element,attrs){element.html(JST[attrs.template]());$compile(element.contents())(scope);};return{link:linker,restrict:'E'}});app.filter('encodeURIComponent',function(){return window.encodeURIComponent;});app.filter('encodeURI',function(){return window.encodeURI;});app.filter('showAttr',function(){return function(obj){if(obj&&obj.hasOwnProperty('display')){if(obj.display===null||obj.display===undefined){return'';}
return''+obj.display;}
else{return obj;}}});app.factory('RecentQueries',function(){return[];});

function curiousJoinTable(results,set_table_cb,object_cache_f,get_objects_f){




 var GET_BATCH=500; var DEFAULT_PAGE_SIZE=100;var entries=[];var models=[]; var tbl_queries=[];var tbl_attrs=[];var tbl_rows=[];var tbl_view=undefined;var tbl_csv=undefined;var tbl_controls={};var pourover_collection=undefined;var pourover_sorters=undefined;var outstanding_fetches=0; var object_cache=object_cache_f();
 for(var i=0;i<results.length;i++){results[i].map={}
for(var j=0;j<results[i].objects.length;j++){var obj=results[i].objects[j];if(results[i].map[obj[0]]===undefined){results[i].map[obj[0]]=[];}
results[i].map[obj[0]].push(obj);}}
function build_obj(col,res_obj){return{model:results[col].model,id:res_obj[0],url:res_obj[1],from:res_obj[2]};}
var entries=[];var last_column=results[results.length-1];for(var i=0;i<last_column.objects.length;i++){entries.push([build_obj(results.length-1,last_column.objects[i])]);}
for(var col=results.length-2;col>=0;col--){var new_entries=[];for(var i=0;i<entries.length;i++){var row=entries[i];var last_from=row[0].from; var objs=results[col].map[last_from];for(var j=0;j<objs.length;j++){var new_row=row.slice(0);new_row.unshift(build_obj(col,objs[j]));new_entries.push(new_row);}}
entries=new_entries;}


for(var i=0;i<entries.length;i++){for(var j=0;j<entries[i].length;j++){var entry=entries[i][j];var obj_id=entry.model+'.'+entry.id;if(object_cache[obj_id]===undefined){var id_str=''+entry.id;if(entry.url){id_str='<a href="'+entry.url+'">'+entry.id+'</a>';}
object_cache[obj_id]={id:{value:entry.id,display:id_str}};}
entry['ptr']=object_cache[obj_id];}} 
for(var j=0;j<entries[0].length;j++){tbl_queries.push({model:entries[0][j].model,cols:1});models.push({model:entries[0][j].model,attrs:[{name:'id',visible:true}],loaded:false});}
function _get_attr_value(value){if(value&&value.value!==undefined){value=value.value;if(value&&value.model&&value.__str__!==undefined){return value.__str__;}}
return value;}
function _lc(s){if(typeof s==='string'){return s.toLowerCase();}return s;} 
function add_object_data(model,obj_data){var id=obj_data.id;var obj_id=model+'.'+id;var ptr=object_cache[obj_id];ptr['__fetched__']=obj_data;for(var a in obj_data){ if(a!=='id'){
var v=obj_data[a];var s=v;if(v&&v.model){if('__str__'in v){s=v['__str__'];if(v.id){s+=' ('+v.id+')';}}
if('url'in v&&v.url){s='<a href="'+v.url+'">'+s+'</a>';}}
ptr[a]={value:v,display:s};}}}

function get_objects(model,ids,cb){var cb_data=undefined;var unfetched=[];for(var i=0;i<ids.length;i++){var id=ids[i];var obj_id=model+'.'+id;if(obj_id in object_cache&&object_cache[obj_id]['__fetched__']){cb_data=object_cache[obj_id]['__fetched__'];}
else{unfetched.push(id);}}
if(cb_data!==undefined&&cb){cb(cb_data);}
if(unfetched.length>0){while(unfetched.length>0){var tofetch=unfetched.slice(0,GET_BATCH);var unfetched=unfetched.slice(GET_BATCH);outstanding_fetches+=1;get_objects_f(model,tofetch,function(results){outstanding_fetches-=1;var fields=results.fields;for(var i=0;i<results.objects.length;i++){var obj_data={};var values=results.objects[i];for(var j=0;j<fields.length;j++){obj_data[fields[j]]=values[j];if(Object.prototype.toString.call(values[j])==='[object Array]'){obj_data[fields[j]]={model:values[j][0],id:values[j][1],__str__:values[j][2],url:values[j][3]}}}
add_object_data(model,obj_data);if(cb_data===undefined&&cb){cb_data=obj_data;cb(obj_data);}}});}}}
function csv(){if(tbl_rows.length==0){return"";}
var csv_rows=[]
var row0=tbl_rows[0];var header=[];for(var i=0;i<tbl_attrs.length;i++){var model=row0[i].model;header.push(model+'.'+tbl_attrs[i].name);}
csv_rows.push(header.join(','));for(var i=0;i<tbl_rows.length;i++){var row=[];for(var j=0;j<tbl_rows[i].length;j++){var entry=tbl_rows[i][j];if(entry){var obj=entry.ptr;if(obj){var v=obj[tbl_attrs[j].name];if(v.display){v=v.value;}
if(v){v=''+v; v=v.replace("\n"," ");v=v.replace("\t"," ");v=v.replace("\"","");v=v.replace("\'","");v="\""+v+"\"";}
row.push(v);}
else{if(tbl_attrs[j].name=='id'){row.push(entry.id);}
else{row.push('');}}}
else{if(tbl_attrs[j].name=='id'){row.push(entry.id);}
else{row.push('');}}}
csv_rows.push(row.join(','));}
return csv_rows.join('\n');}
function update_pourover(page_size){var col_data=[];for(var i=0;i<tbl_rows.length;i++){var d={i:i,row:tbl_rows[i]};col_data.push(d);}
pourover_collection=new PourOver.Collection(col_data);pourover_sorters={};if(page_size===undefined){page_size=DEFAULT_PAGE_SIZE;}
tbl_view=new PourOver.View('default',pourover_collection,{page_size:page_size});tbl_controls={};}
function next_page(){tbl_view.page(1);}
function prev_page(){tbl_view.page(-1);}
function sort(column_index){function _sorter_name(col,reverse){if(reverse){return'_dsc_col_'+col;}
else{return'_asc_col_'+col;}}
function _make_sorter_class(col,attr,reverse){var ColSorter=PourOver.Sort.extend({fn:function(a,b){if(a.row[col].ptr[attr]===undefined){return 1;}
if(b.row[col].ptr[attr]===undefined){return-1;}
var v_a=a.row[col].ptr[attr];var v_b=b.row[col].ptr[attr];v_a=_get_attr_value(v_a);v_b=_get_attr_value(v_b);if(reverse){var tmp=v_a;v_a=v_b;v_b=tmp;}
if(v_a===undefined||v_a===null){return 1;}
if(v_b===undefined||v_b===null){return-1;}
if(v_a>v_b){return-1;}
else if(v_a<v_b){return 1;}
else{return 0;}}});return ColSorter;}
function _create_sorter(col){var asc_sorter_name=_sorter_name(col,false);var dsc_sorter_name=_sorter_name(col,true);if(pourover_sorters[asc_sorter_name]===undefined){var ColSorterAsc=_make_sorter_class(col,tbl_attrs[col].name,true);var ColSorterDsc=_make_sorter_class(col,tbl_attrs[col].name,false);var sorters=[new ColSorterAsc(asc_sorter_name),new ColSorterDsc(dsc_sorter_name)];pourover_sorters[asc_sorter_name]=sorters;pourover_collection.addSorts(sorters);}
return[asc_sorter_name,dsc_sorter_name];} 
if(outstanding_fetches>0){return;} 
var sorters=_create_sorter(column_index);var sorter;if(tbl_controls.sort_column&&tbl_controls.sort_column===column_index){if(tbl_controls.sort_asc===false){tbl_controls.sort_asc=true;sorter=sorters[0];}
else{tbl_controls.sort_asc=false;sorter=sorters[1];}}
else{tbl_controls.sort_column=column_index;tbl_controls.sort_asc=true;sorter=sorters[0];}
tbl_view.setSort(sorter);}
function make_filter(column_index){var attr=tbl_attrs[column_index].name;var colFilter=PourOver.Filter.extend({cacheResults:function(items){var possibilities=this.possibilities;_(items).each(function(i){var value=i.row[column_index].ptr[attr];value=_get_attr_value(value)
if(value===undefined||value===null){value='';}
else{value=_lc(value);}
_(possibilities).each(function(p){if(_lc(p.value)===value){p.matching_cids=PourOver.insert_sorted(p.matching_cids,i.cid)}})});},addCacheResults:function(new_items){this.cacheResults.call(this,new_items);},getFn:function(query){var query_lc=_lc(query);var matching_possibility=_(this.possibilities).find(function(p){var value_lc=_lc(p.value);return value_lc===query_lc;});return this.makeQueryMatchSet(matching_possibility.matching_cids,query)}});var _mk_filter=function(name,values,attr){var values=_(values).map(function(i){return{value:i}}),opts={associated_attrs:[attr],attr:attr},filter=new colFilter(name,values,opts);return filter;}
var possibilities=[];for(var i=0;i<tbl_rows.length;i++){var v=tbl_rows[i][column_index].ptr[attr];v=_get_attr_value(v);if(v===undefined||v===null){v='';}
if(possibilities.indexOf(v)<0){possibilities.push(v);}}
var column_filter=_mk_filter("col_"+column_index+"_filter",possibilities,attr);pourover_collection.addFilters([column_filter])
if(tbl_controls.filters===undefined){tbl_controls.filters={};}
tbl_controls.filters[column_index]=possibilities;}
function filter(column_index,value){var filter_name='col_'+column_index+'_filter';var filter=pourover_collection.filters[filter_name];if(value!==undefined){filter.query(value);pourover_collection.get(filter.current_query.cids);if(tbl_controls.filtered===undefined){tbl_controls.filtered={};}
tbl_controls.filtered[column_index]=value;}
else{filter.clearQuery();pourover_collection.get(filter.current_query.cids);if(tbl_controls.filtered===undefined){tbl_controls.filtered={};}
tbl_controls.filtered[column_index]=undefined;}
tbl_controls.aggregates={}}
function aggregate(column_index){var attr=tbl_attrs[column_index].name;var objs=pourover_collection.get(tbl_view.match_set.cids);var counts={};for(var i=0;i<objs.length;i++){var v=objs[i].row[column_index].ptr[attr];v=_get_attr_value(v);v=_lc(v);if(v===undefined||v===null){v='';}
if(counts[v]===undefined){counts[v]=0;}
counts[v]+=1;}
if(tbl_controls.aggregates===undefined){tbl_controls.aggregates={};}
tbl_controls.aggregates[column_index]=counts;}
function update_csv(){if(tbl_csv){tbl_csv=csv();}}

function update_table(){tbl_attrs=[];var attr_model_idx=[];for(var i=0;i<models.length;i++){for(var j=0;j<models[i].attrs.length;j++){tbl_attrs.push(models[i].attrs[j]);attr_model_idx.push(i);}}
tbl_rows=[];for(var i=0;i<entries.length;i++){var row=[];for(var j=0;j<tbl_attrs.length;j++){var k=attr_model_idx[j];row.push(entries[i][k]);}
tbl_rows.push(row);}
update_pourover(); update_csv(); update_controller();}
function update_controller(){ set_table_cb({queries:tbl_queries,attrs:tbl_attrs,length:tbl_rows.length,view:tbl_view,controls:tbl_controls,csv:tbl_csv, toggleQuery:toggle,showCSV:show_csv,nextPage:next_page,prevPage:prev_page,sort:sort,make_filter:make_filter,filter:filter,aggregate:aggregate});}

function update_model_attrs(query_idx,object){if(models[query_idx].attrs.length==1){var old_attr=models[query_idx].attrs[0];var attrs=[];for(var a in object){if(a!=='id'){attrs.push({name:a,visible:true});}}
attrs.sort(function(a,b){return a.name-b.name;});attrs.unshift(old_attr);models[query_idx].attrs=attrs;tbl_queries[query_idx].cols=attrs.length;update_table();}} 
function show_object_attrs(query_idx){if(models[query_idx].loaded==true){ for(var i=0;i<models[query_idx].attrs.length;i++){models[query_idx].attrs[i].visible=true;}
tbl_queries[query_idx].cols=models[query_idx].attrs.length;return;} 
var ids=[];for(var i=0;i<entries.length;i++){var entry=entries[i][query_idx];ids.push(entry.ptr.id.value);}
get_objects(models[query_idx].model,ids,function(data){update_model_attrs(query_idx,data);models[query_idx].loaded=true;},function(){console.log('all fetch completed');});} 
function hide_object_attrs(query_idx){ for(var i=0;i<models[query_idx].attrs.length;i++){if(models[query_idx].attrs[i].name!=='id'){models[query_idx].attrs[i].visible=false;}}
tbl_queries[query_idx].cols=1;}
function toggle(query_idx){if(tbl_queries[query_idx].cols==1){show_object_attrs(query_idx);}
else{hide_object_attrs(query_idx);}}
function show_csv(){tbl_csv=csv();update_controller();}
update_table();
 if(entries.length>0&&entries[0].length>0){show_object_attrs(entries[0].length-1);}}'use strict';function QueryController($scope,$http){function init_query(){$scope.completed=false;$scope.success=false;$scope.search_error=undefined;$scope.last_model=undefined;$scope.last_model_rels=[];$scope.table=undefined;$scope.csv=false;}
function get_model(model,cb){var url=$scope.__base_url+'/models/'+model+'/';$http.get(url).success(function(data){if(data.result){cb(data.result,undefined);}
else{cb(undefined,"Cannot retrieve model information from server");}}).error(function(data,status,headers,config){if(data.error){cb(undefined,data.error.message);}
else{cb(undefined,"Unspecified error from server");}});}
function get_object(model,id,cb){var url=$scope.__base_url+'/objects/'+model+'/'+id+'/';$http.get(url).success(function(data){if(data.result){cb(data.result);}});}
function get_objects(model,ids,cb){var url=$scope.__base_url+'/models/'+model+'/';$http.post(url,{ids:ids}).success(function(data){if(data.result){cb(data.result);}});}
function do_query(query_string,reload,cb){var url=$scope.__base_url+'/q/';var url=url+'?q='+encodeURIComponent(query_string);if(reload){url=url+'&r=1';}
$http.get(url).success(function(data){if(data.result){cb(data.result,undefined);}
else{cb(undefined,"Did not receive results from server");}}).error(function(data,status,headers,config){if(data.error){cb(undefined,data.error.message);}
else{cb(undefined,"Unspecified error from server");}});}
function execute(){init_query();var query=$scope.query;do_query(query,$scope.query_info.reload,function(res,err){$scope.completed=true;if(err){$scope.success=false;$scope.search_error=err;}
else{$scope.success=true;if(res.last_model){$scope.last_model=res.last_model;}
if(res.results.length>0){get_model($scope.last_model,function(res,error){if(res){if(res.relationships){$scope.last_model_rels=res.relationships;}}}); curiousJoinTable(res.results,function(tbl){$scope.table=tbl;},function(){return $scope.$parent._object_cache;},get_objects);}}});}
$scope.toggleCSV=function(){if($scope.csv){$scope.csv=false;}
else{if(!$scope.table.csv){$scope.table.showCSV();}
$scope.csv=true;}};$scope.query=$scope.query_info.query;execute();};'use strict';function SearchController($scope,$routeParams,$http,$timeout,$location,RecentQueries){$scope.__base_url='/curious'; $scope._object_cache={};$scope.query='';$scope.query_error='';$scope.query_accepted='';$scope.delayPromise=undefined;$scope.recent_queries=RecentQueries;$scope.query_submitted=[];if($routeParams&&$routeParams.query){$scope.query=$routeParams.query;$scope.query_submitted=[{query:$scope.query,reload:false}];var i=$scope.recent_queries.indexOf($routeParams.query);if(i<0){$scope.recent_queries.unshift($routeParams.query);}}
$scope.delayCheckQuery=function(){if($scope.delayPromise!==undefined){$timeout.cancel($scope.delayPromise);$scope.delayPromise=undefined;}
$scope.delayPromise=$timeout(function(){$scope.checkQuery();$scope.delayPromise=undefined;},1000);};$scope._check_query=function(query_string,cb){var url=$scope.__base_url+'/q/';var url=url+'?c=1&q='+encodeURIComponent(query_string);$http.get(url).success(function(data){cb(data.result.query,'');}).error(function(data,status,headers,config){var err='';if(data.error){err=data.error.message;}
else{err='Unspecified error';}
cb('',err);});};$scope._new_query=function(query,reload){var url='/q/'+encodeURI(query);$location.path(url);$scope.query_submitted=[{query:$scope.query,reload:reload}];}
$scope.checkQuery=function(cb){if($scope.query!=''){$scope._check_query($scope.query,function(query_string,err){$scope.query_error=err;$scope.query_accepted=query_string;if(cb!==undefined){cb(query_string,err);}});}};$scope.submitQuery=function(reload){if(reload===undefined){reload=false;}
$scope.checkQuery(function(query_string,err){if(query_string!==''){$scope._new_query(query_string,reload);}});};$scope.refreshQuery=function(){$scope.reload=true;};$scope.extendQuery=function(model,rel){$scope.query=$scope.query+' '+model+'.'+rel;$scope.submitQuery();};}